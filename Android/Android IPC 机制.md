# IPC 机制

IPC（Inter-Process Communication）指两个进程间进程进行数据交换的方法。

## Linux IPC 机制

Linux 常用的进程间通信方法包括：管道、消息队列、信号、信号量、共享内存、套接字等。

### 管道

管道实际是用于进程间通信的一段共享内存，创建管道的进程称为管道服务器，连接到一个管道的进程为管道客户机。一个进程在向管道写入数据后，另一进程就可以从管道的另一端将其读取出来。

#### 无名管道

* 半双工
* 只能用于父子进程、兄弟进程
* 构成独立文件系统，且只存在于 **内存**

#### 有名管道

以文件形式存在，运行没有亲缘关系进程间通信

### 消息队列

消息队列是消息的链表，存放在内核中并由消息队列标识符表示。

* 生命周期随内核，消息队列会一直存在，需要我们显示的调用接口删除或使用命令删除
* 消息队列可以双向通信
* 克服了管道只能承载无格式字节流的缺点

### 套接字

传输效率低，主要用于不同机器、跨网络通信

### 信号

### 信号量

信号量是一种计数器，用于控制对多个进程共享的资源进行的访问。它们常常被用作一个锁机制，在某个进程正在对特定的资源进行操作时，信号量可以防止另一个进程去访问它。

### 共享内存

共享内存方式直接将某段内存段进行映射，多个进程间的共享内存是同一块的物理空间，共享内存是IPC最快捷的方式。

**共享内存本身并没有同步机制，需要程序员自己控制。**




## Android IPC

Android 为每一个应用分配了一个独立的虚拟机。不同虚拟机访问同一个类的对象会产生**多个对象**。

**产生问题：**

* 静态成员与单例模式完全失效
* 线程同步机制失效
* SharedPreferences 可靠性下降（并发读写）
* Application 多次创建

## IPC 基础

### 序列化

* **Serializable**： Java 中的序列化接口，使用简单，开销大。

* **Parcelable**：Android 中的序列化方式，使用复杂，效率高。主要使用在内存序列化，如对象序列化等功能上。

* **Binder**： 

Binder 是 Android 中的一个类，实现了 IBinder 接口。可理解为一种跨进程通信方式，也可理解为一种虚拟物理设备，设备驱动为 /dev/binder。
从 AndroidFramework 角度说，Binder 是链接各 ServiceManager 与 Manager 的桥梁。
Android 开发中 Binder 主要用在 Service 中，包括 AIDL 与 Messenger。

采用 Binder 的原因：

    * 性能：Binder 只需要拷贝一次，管道、消息队列、Socket 都需要两次
    * 稳定性：Binder 采用 C/S 架构，共享内存实现方式复杂，且存在并发同步问题
    * 安全性：Linux IPC 无法获取对方 UID/PID，Android 会鉴别 UID
    * 语言方面：Linux 基于 C，Android 基于 Java，Binder 符号面向对象思想

## Android 中的 IPC 方式

### Bundle

### 文件共享

### **Messenger**

Messenger 翻译为信使，通过它可以在不同进程中传递 Message 对象。其底层是 AIDL。由于它一次处理一个请求，因此**无需考虑线程同步**的问题。

###  AIDL

AIDL 意思即 Android Interface Definition Language（Android接口定义语言），是用于定义服务器和客户端通信接口的一种描述语言，可以拿来生成用于IPC的代码。从某种意义上说AIDL其实是一个模板，因为在使用过程中，实际起作用的并不是AIDL文件，而是据此而生成的一个IInterface的实例代码（从中可获得Binder实例），AIDL其实是为了避免我们重复编写代码而出现的一个模板。

设计AIDL这门语言的目的就是为了实现进程间通信。在Android系统中，每个进程都运行在一块独立的内存中，在其中完成自己的各项活动，与其他进程都分隔开来。可是有时候我们又有应用间进行互动的需求，比较传递数据或者任务委托等，AIDL就是为了满足这种需求而诞生的。
通过AIDL，可以在一个进程中获取另一个进程的数据和调用其暴露出来的方法，从而满足进程间通信的需求
通常，暴露方法给其他应用进行调用的应用称为服务端，调用其他应用的方法的应用称为客户端，客户端通过绑定服务端的Service来进行交互。

Messenger 以串行的方式处理客户端发来的消息，不适合大量的并发请求。AIDL 是 Messenger 的底层实现。

### ContentProvider

ContentProvider 底层也是 Binder。

### Socket


*参考*：

[Linux下的几种IPC方式及其C语言实现](https://www.cnblogs.com/acm-icpcer/p/8933628.html)

[为什么 Android 要采用 Binder 作为 IPC 机制？](https://www.zhihu.com/question/39440766/answer/89210950)